<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN" "http://www.w3.org/TR/REC-html40/loose.dtd">
<html><head>
<title> 
F-SEFI installation and user manual
</title>

<meta http-equiv="Content-Type" content="text/html; charset=windows-1252">
<meta name="GENERATOR" content="hevea 1.10">
<style type="text/css">
.li-itemize{margin:1ex 0ex;}
.li-enumerate{margin:1ex 0ex;}
.dd-description{margin:0ex 0ex 1ex 4ex;}
.dt-description{margin:0ex;}
.toc{list-style:none;}
.thefootnotes{text-align:left;margin:0ex;}
.dt-thefootnotes{margin:0em;}
.dd-thefootnotes{margin:0em 0em 0em 2em;}
.footnoterule{margin:1em auto 1em 0px;width:50%;}
.caption{padding-left:2ex; padding-right:2ex; margin-left:auto; margin-right:auto}
.title{margin:2ex auto;text-align:center}
.center{text-align:center;margin-left:auto;margin-right:auto;}
.flushleft{text-align:left;margin-left:0ex;margin-right:auto;}
.flushright{text-align:right;margin-left:auto;margin-right:0ex;}
DIV TABLE{margin-left:inherit;margin-right:inherit;}
PRE{text-align:left;margin-left:0ex;margin-right:auto;}
BLOCKQUOTE{margin-left:4ex;margin-right:4ex;text-align:left;}
TD P{margin:0px;}
.boxed{border:1px solid black}
.textboxed{border:1px solid black}
.vbar{border:none;width:2px;background-color:black;}
.hbar{border:none;height:2px;width:100%;background-color:black;}
.hfill{border:none;height:1px;width:200%;background-color:black;}
.vdisplay{border-collapse:separate;border-spacing:2px;width:auto; empty-cells:show; border:2px solid red;}
.vdcell{white-space:nowrap;padding:0px;width:auto; border:2px solid green;}
.display{border-collapse:separate;border-spacing:2px;width:auto; border:none;}
.dcell{white-space:nowrap;padding:0px;width:auto; border:none;}
.dcenter{margin:0ex auto;}
.vdcenter{border:solid #FF8000 2px; margin:0ex auto;}
.minipage{text-align:left; margin-left:0em; margin-right:auto;}
.marginpar{border:solid thin black; width:20%; text-align:left;}
.marginparleft{float:left; margin-left:0ex; margin-right:1ex;}
.marginparright{float:right; margin-left:1ex; margin-right:0ex;}
.theorem{text-align:left;margin:1ex auto 1ex 0ex;}
.part{margin:2ex auto;text-align:center}
</style>
</head>
<body>
<!--HEVEA command line is: /usr/bin/hevea -fix howto.tex -->
<!--CUT DEF section 1 -->
<table class="title"><tbody><tr><td><h1 class="titlemain"><br>
<b>FSEFI Installation and User Manual</b></h1>
<h3 class="titlerest">Qiang Guan, Ph.D.</h3>
<h3 class="titlerest">Ultrascale Systems Research Center (USRC)</h3>
<h3 class="titlerest">High Performance Computing (HPC) division</h3>
<h3 class="titlerest">Los Alamos National Laboratory (LANL)</h3>
<h3 class="titlerest">under contract by U.S. Department of Energy (DOE)</h3>
<h3 class="titlerest">Feb 19th, 2015: Release 1.0 on Ubuntu 12.04 (based on TEMU-1.0) </h3>
</td></tr>
</tbody></table>

<!--TOC section Contents-->
<h2 class="section"><!--SEC ANCHOR -->Contents</h2><!--SEC END --><ul class="toc">
<li class="li-toc"><a href="#htoc0">1&nbsp;&nbsp;Attribution</a></li>
<li class="li-toc"><a href="#htoc1">1&nbsp;&nbsp;Introduction</a></li>
<li class="li-toc"><a href="#htoc2">2&nbsp;&nbsp;Installation</a></li>
<li class="li-toc"><a href="#htoc3">3&nbsp;&nbsp;Configuring a New VM</a></li>
<li class="li-toc"><a href="#htoc4">4&nbsp;&nbsp;Booting a VM Using FSEFI</a></li>
<li class="li-toc"><a href="#htoc5">5&nbsp;&nbsp;Injecting Faults</a></li>
<li class="li-toc"><a href="#htoc6">6&nbsp;&nbsp;Batch Mode</a></li>
<li class="li-toc"><a href="#htoc7">7&nbsp;&nbsp;Troubleshooting</a></li>
<li class="li-toc"><a href="#htoc8">8&nbsp;&nbsp;Acknowledgements</a></li></ul>

<!--TOC section Attribution-->
<h2 class="section"><!--SEC ANCHOR --><a name="htoc0">1</a>&nbsp;&nbsp;Attribution</h2>
<!--SEC END -->
<p>The Fine-grained Soft Error Fault Injector (FSEFI) is a software fault
injector developped by Los Alamos National Laboratory (LANL) since 2011.  LANL
is managed by the U.S. Department of Energy (DOE).  F-SEFI was developed at the
<a href="http://newmexicoconsortium.org/research/advanced-computing/usrc">Ultrascale Systems Research Center (USRC)</a>
at the <a href="http://newmexicoconsortium.org/">New Mexico Consortium</a>.
Its creators and maintainers are from
the High Performance Computing (HPC) division of LANL and has these
contributors:
<ol>
<li>Nathan DeBardeleben, Ph.D. (<a
href="mailto:ndebard@lanl.gov">ndebard@lanl.gov</a>) - project PI, manager,
etc.</li>
<li>Qiang Guan, Ph.D. (<a href="mailto:qguan@lanl.gov">qguan@lanl.gov</a>) -
primary developer, maintainer, research</li>
<li>Sean Blanchard (<a href="mailto:seanb@lanl.gov">seanb@lanl.gov</a>) -
operating systems, kernels, etc.</li>
<li>Conor Robinson - F-SEFI usage, experiments, etc.</li>
<li>Laura Monroe, Ph.D. - algorithms</li>
<li>William Jones, Ph.D. - algorithms, Coastal Carolina University</li>
<li>Claude "Rusty" Davis - algorithms, experiments, Clemson University</li>
</ol>
<p>
Copyright (C) 2011, 2014 Los Alamos National Security.  ALL RIGHTS RESERVED.
<p>
All questions and inquiries about F-SEFI should be directed to Nathan
DeBardeleben at Los Alamos National Laboratory - <a href="mailto:ndebard@lanl.gov">ndebard@lanl.gov</a>.
</p>

<!--TOC section Introduction-->
<h2 class="section"><!--SEC ANCHOR --><a name="htoc1">1</a>&nbsp;&nbsp;Introduction</h2>
<!--SEC END -->
<p> F-SEFI capitalizes on extensive open source work in the QEMU/TEMU processor
emulator virtal machine (VM). F-SEFI connects to the QEMU hypervisor and allows
controlled fault injection into the VM from the host. All of the injection operations runs
entirely in user space from the host aspect but from the VM guest aspect, where the
applications runs, the injection operations runs in hardwares. This feature enables us
to emulate the faults in hardware without any instrusions to kernel or privelges on both
host and guest VMs. FSEFI supports two levels of fault injections: Course-grained and Fine-grained.</p>
    <dl style="list-style-type:circle">
        <dt><b>Course-grained</b></dt>
        <dd>- Injecting faults into target application level. Faults are injected into the application
        at any time in any functions that associates with your target operation.</dd>
        <dt><b>Fine-grained</b></dt>
        <dd>- Injecting faults into the sub-function level of the target application. Faults are
        injected into the function even target lines-of-code (LOC) with the support of Function Symbol Table (FST) </dd>
    </dl>
 <!--   We will talk about how to configure FSEFI for different levels of injection and how to
    generate FST and pass the FST to FSEFI in the following sections. -->

<p> This document is a quick start guide for setting up and running FSEFI. The
instructions are based on the release of FSEFI-1.0 shown in the header,
running on a vanilla <mark>Ubuntu 12.04 64-bits
distribution of Linux </mark>. We intermix instructions with explanations
about functions to provide a tutorial of how FSEFI works on injecting faults.

The goal in this exercise is to take a simple program, profile the program, configure the fault injector
based on the profile, execute the fault inejction at runtime, trace the injection via F-SEFI logs.
</p>

<!--TOC section Installation-->
<h2 class="section"><!--SEC ANCHOR --><a name="htoc2">2</a>&nbsp;&nbsp;<a name="sec:install"></a>Installation</h2>
<!--SEC END -->
<p>If you are a new user, please log in your account and cp all the files (inlcuding source code, scripts and image file) from <tt>/home/fsefi_shared/</tt> directory</p>
<pre class="verbatim">
$ cp -r /home/fsefi_shared/* ~/ 
$ ls   
FSEFI_CURRENT image install-fsefi.sh
</pre>
<p>The following script shows the steps for
building and installing FSEFI and the other software it depends on:

(This is also found as
<code>docs/install-fsefi.sh</code> in the code base, you can simply run it to install FSEFI and all the packages
). We have another script for installing all the dependency packages that requre for building FSEFI. </p>

<!-- Horizontal line for seperation 
<table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td colspan="3" bgcolor="black"><table border="0" cellpadding="0" cellspacing="2"><tbody><tr><td>
</td></tr>
</tbody></table></td></tr>
<tr><td><table border="0" cellpadding="10" cellspacing="0"><tbody><tr><td>
-->
<pre class="verbatim">
#!/bin/bash
# Instructions for installing FSEFI 1.0 on Ubuntu 12.04 Linux 64-bit
<!--
# Things that require root access are preceded with "sudo".

# FSEFI is based on QEMU. It's useful to have a vanilla QEMU for testing
# and image development:
sudo apt-get -y install qemu #optional

# You may need to install some packages required for libSDL
sudo apt-get -y install build-essential xorg-dev libudev-dev libts-dev libgl1-mesa-dev libglu1-mesa-dev
libasound2-dev libpulse-dev libopenal-dev libogg-dev libvorbis-dev libaudiofile-dev libpng12-dev
libfreetype6-dev libusb-dev libdbus-1-dev zlib1g-dev libdirectfb-dev libssl-dev

# Install the libSDL
sudo apt-get -y install libsdl*

# Install bfd package
sudo apt-get -y install libbfd-dev

# Install SSH package for communication
sudo apt-get -y install openssh*

# assuming that fsefi-1.0.tar.gz is in /home/youraccount/ with this installation script.
cd ~
# unpack the source
tar xvzf fsefi-1.0.tar.gz
-->
# You will see the folder called FSEFI_CURRENT from extracting the tarball
cd FSEFI_CURRENT

# Build the sleuthkit-2.04
(cd shared/sleuthkit && make)
(cd shared && ln -s sleuthkit-2.04 sleuthkit)

# Build the llconf
(cd shared/llconf && CFLAGS="-fPIC" ./configure --prefix=$(pwd)/install)
(cd shared/llconf && make)
(cd shared/llconf && make install)
(cd shared && ln -s llconf-0.4.6 llconf) 

# Build FSEFI
./configure --target-list=i386-softmmu --proj-name=tracecap --prefix=$(pwd)/install --disable-gcc-check
make clean
make 

<!-- Horizontal line for seperation 
<table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td colspan="3" bgcolor="black"><table border="0" cellpadding="0" cellspacing="2"><tbody><tr><td>
</td></tr>
</tbody></table></td></tr>
<tr><td><table border="0" cellpadding="10" cellspacing="0"><tbody><tr><td>
-->

</pre><!--TOC section Configuring a new VM-->
<h2 class="section">
<!--SEC ANCHOR -->
<a name="htoc3">3</a>&nbsp;&nbsp;<a name="sec:vmconfig"></a>Configuring a new VM</h2>
<!--SEC END -->
<p>Generally QEMU is compatible with almost any guest OS that runs on X86 architecture, currently FSEFI is
only supporting Linux. We port the linux kernel data structure into FSEFI kernel to extract the OS abstraction
like processes. In this way, FSEFI can be aware of the starting of specific application by monitoring
the <code>task_struct</code> list.

This release of FSEFI works with VMs running Ubuntu Linux 9.04 32-bit.
</p>

<b>Linux-based VM Image: </b>
We have prepared Ubuntu linux 9.04 32-bit VM image for test. You can find the image file named
<code>ubuntu_9.04_32.img</code> in the installation package. You can clone a snapshot image from
the original images using Redirect-on-Write to avoid changing the original image and keep
your snapshot image small in size and save time when cloning a new VM.
But the snapshot image and the backing image file (where the snapshot image built on) must be kept together.
For example if you want to create a snapshot of our provided image file <code>ubuntu_9.04_32.img</code>
for testing algorithm_A, create a new QCow2 format image file called <code>ubuntu_9.04_32_algorithm_A.img</code>
using <code>-b</code> flag to indicate the backing image. The new image is now a read/write snapshot of
the original backing image. Any changes (e.g., adding files/directories and removing files/diretories ) to the 
<code>ubuntu_9.04_32_algorithm_A.img</code> will not be reflected in <code>ubuntu_9.04_32.img</code>.</p>

<p>A command line to create a snapshot image look like: </p>
<table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td colspan="3" bgcolor="black"><table border="0" cellpadding="0" cellspacing="2"><tbody><tr><td>
</td></tr>
</tbody></table></td></tr>
<tr><td><table border="0" cellpadding="10" cellspacing="0"><tbody><tr><td>
<pre class="verbatim">
% qemu-img create -f qcow2 -b ubuntu_9.04_32.img ubuntu_9.04_32_algorithm_A.img
</pre></td></tr>
</tbody></table></td></tr>
<tr><td colspan="3" bgcolor="black"><table border="0" cellpadding="0" cellspacing="2"><tbody><tr><td>
</td></tr>
</tbody></table></td></tr>
</tbody></table></td></tr>
</tbody></table>

<p>At this point, if you run the backing image and do any changes to the backing image will corrupt all
the snapshot images that were built based on the this backing image. Please make sure the image you are
going to delete is not the backing image.
</p>
<p>You can use qemu-img info to check an image's backing image file: </p>
<table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td colspan="3" bgcolor="black"><table border="0" cellpadding="0" cellspacing="2"><tbody><tr><td>
</td></tr>
</tbody></table></td></tr>
<tr><td><table border="0" cellpadding="10" cellspacing="0"><tbody><tr><td>
<pre class="verbatim">
% qemu-img info ubuntu_9.04_32_algorithm_A.img
image: ubuntu_9.04_32_algorithm_A.img
file format: qcow2
virtual size: 40G (42949672960 bytes)
disk size: 196K
cluster_size: 65536
backing file: <mark>ubuntu_9.04_32.img</mark>
Format specific information:
    compat: 1.1
    lazy refcounts: false
</pre></td></tr>
</tbody></table></td></tr>
<tr><td colspan="3" bgcolor="black"><table border="0" cellpadding="0" cellspacing="2"><tbody><tr><td>
</td></tr>
</tbody></table></td></tr>
</tbody></table></td></tr>
</tbody></table>



<!--TOC section Setting up TEMU network-->
<h2 class="section"><!--SEC ANCHOR --><a name="htoc4">4</a>&nbsp;&nbsp;Booting a VM Using FSEFI</h2>
<!--SEC END -->
<p><a name="sec:setup"></a></p>
<p> After you create your first snapshot image, now you can boot your image using FSEFI. You can create
a script named <code>startvm.sh</code> under directory of SEFI_CURRENT:</p>
<pre class="verbatim">
#! /bin/sh
# Make sure you have the binary file <code>fsefi</code>
# We assume the snapshot image is located in upper level of SEFI_CURRENT
# Options:
#  -monitor stdio : monitor the VM
#  -m 512         : assign 512MB memory for this VM
#  -k en-us       : keyboard Eng-US
#  -cpu core2duo  : Emulated CPU type
./tracecap/fsefi ../ubuntu_9.04_32_algorithm_A.img -monitor stdio -m 512  -k en-us -cpu core2duo
</pre>

<p>The booted VM is using default user mode network, so you don't have to configure the network for
this VM. The advantage is that you can generate many VMs working on different projects but never need to
manage the network configuration for the group of VMs. And it dones't require any root/administration privileges.
The limitation is that the guest is not directly accessible from the host or the external network.
So in your guest VM, if you want to install any packages, run your application or transfering files or codes,
you have to access the guest VM using the graphic interface initialized by <code>startVM.sh</code> (that is why
we use <code>-monitor stdio</code> to boot the image). </p>

<!--    
    Running QEMU by itself should be the first step, before you try to run
TEMU. There are many platform specific tweaks that you may need in
order to get QEMU usable for your project. Though not needed for this
excercise, you will often need to set up a network inside the QEMU
image that you use. You may skip this network setup section, if you
will not need this.</p><p>This document does not intend to go into great depth in setting up
QEMU itself. But we describe some mechanisms that have worked for
us. You may need a bit Googling to set this up on your specific
platform and network configuration.</p><ul class="itemize"><li class="li-itemize"><b>Method 1</b> - User-level network emulation<p>The simplest kind of network emulation, which QEMU performs by
default, uses just user-level network primitives on the host side, and
simulates a private network for the virtual machine. This is
sufficient for many utility purposes, such as transferring files to
and from the virtual machine, but it may not be accurate enough for
some kinds of malicious network use. The QEMU options for enabling
this mode explicitly are
<code>-net nic -net user,hostname=mybox</code>, where <code>mybox</code> is the
hostname for the virtual DHCP server to provide to the VM.</p><p>If you want to connect to well-known services on the VM, you’ll need
to redirect them to alternate ports on the host with the
<code>-redir</code> option. For instance, to make it possible to SSH to a
server on the VM, give QEMU the option <code>-redir tcp:2022::22</code>,
then tell your SSH client to connect to port 2022 on the local
machine.</p></li><li class="li-itemize"><b>Method 2</b> - Use tap network interface.
<table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td colspan="3" bgcolor="black"><table border="0" cellpadding="0" cellspacing="2"><tbody><tr><td>
</td></tr>
</tbody></table></td></tr>
<tr><td><table border="0" cellpadding="10" cellspacing="0"><tbody><tr><td><pre class="verbatim">Create a script /etc/qemu-ifup, including the following lines. Be sure to make 
this script executable.
#!/bin/sh
sudo /sbin/ifconfig $1 192.168.10.1

You must then setup a tap interface. This step can be skipped if you
are willing to run QEMU as root.
$ sudo apt-get install uml-utilities
$ sudo /usr/sbin/tunctl -b user -t tap0

Start the Windows VM. The host machine will have the IP address
192.168.10.1, as is specified in the above script.
$ sudo chmod 666 /dev/net/tun
$ qemu -kernel-kqemu -snapshot -net nic,vlan=0 \
  -net tap,vlan=0,script=/etc/qemu-ifup \
  -monitor stdio /path/to/qemu/image
  
If you don't want to type these commands each time you start TEMU,
you can create a wrapper script which initializes the network,
starts TEMU with desired command-line arguments, then removes the
tap interface once TEMU exits.
</pre></td></tr>
</tbody></table></td></tr>
<tr><td colspan="3" bgcolor="black"><table border="0" cellpadding="0" cellspacing="2"><tbody><tr><td>
</td></tr>
</tbody></table></td></tr>
</tbody></table></td></tr>
</tbody></table></li></ul><p>Once QEMU is set up and running, TEMU should run in the same way. You
can run TEMU’s <tt>qemu</tt> as root, just the same way as you run
QEMU using the installed <tt>qemu</tt> in the PREFIX directory.</p>
-->


<!--TOC section Soft Error Fault Injection-->
<h2 class="section"><!--SEC ANCHOR --><a name="htoc5">5</a>&nbsp;&nbsp;Injecting Faults</h2>
<!--SEC END -->
<p> Now, assuming that FSEFI is compiled and you have launched your VM image using <code>startVM.sh</code>,
     we now walk through and try out an example of injecting soft errors into you application.
    In the following sections, we will use different notions to specify the environment that you have to operate on. <br>
    <b>[Guest:]</b> to indicate the activity in guest linux session. <br>
    <b>[FSEFI:]</b> to indicate the activity in host FSEFI console. <br>
    <b>[Host:]</b> to indicate the activity in host operating system. <br> </p>
    <ol class="enumerate" type="1">
    <li class="li-enumerate">
    <em>Generate a simple program in the QEMU image:</em>
    <p>In the guest Linux session, create a <tt>foo.c</tt> program as follows, and start it: (You can also find
    this code under <tt>/home/guanxyz/USRC/toy/</tt>)</p>
    <table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td>
    <table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td colspan="3" bgcolor="black">
    <table border="0" cellpadding="0" cellspacing="2"><tbody><tr><td></td></tr>
    </tbody></table></td></tr><tr><td>
    <table border="0" cellpadding="10" cellspacing="0"><tbody><tr><td>
    <pre class="verbatim">$ <mark>cat foo.c </mark>
    <!-- HTML generated using hilite.me -->
    <div style="background: #ffffff; overflow:auto;width:auto;border:solid gray;border-width:.1em .1em .1em .8em;padding:.2em .6em;">
        <table><tr><td><pre style="margin: 0; line-height: 125%"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25</pre></td><td>
<pre style="margin: 0; line-height: 125%"><span style="color: #888888">#include &lt;stdio.h&gt;</span>
<span style="color: #888888">#include &lt;stdlib.h&gt;</span>

double mymulfunc(double data){
  <span style="color: #007020">int</span> i;
  double output <span style="color: #333333">=</span> data;
  <span style="color: #008800; font-weight: bold">for</span>(i<span style="color: #333333">=</span><span style="color: #0000DD; font-weight: bold">0</span>; i<span style="color: #333333">&lt;</span><span style="color: #0000DD; font-weight: bold">10</span>; i<span style="color: #333333">++</span>)
    output <span style="color: #333333">*=</span><span style="color: #6600EE; font-weight: bold">1.1</span>;
  <span style="color: #008800; font-weight: bold">return</span> output;
}
double myaddfunc(double data){
  <span style="color: #007020">int</span> i;
  double output <span style="color: #333333">=</span> data;
  <span style="color: #008800; font-weight: bold">for</span>(i<span style="color: #333333">=</span><span style="color: #0000DD; font-weight: bold">0</span>;i<span style="color: #333333">&lt;</span><span style="color: #0000DD; font-weight: bold">10</span>;i<span style="color: #333333">++</span>)
    output <span style="color: #333333">+=</span><span style="color: #6600EE; font-weight: bold">1.1</span>;
  <span style="color: #008800; font-weight: bold">return</span> output;
}
<span style="color: #007020">int</span> main(<span style="color: #007020">int</span> argc, char <span style="color: #333333">*</span> argv[]){
  double data <span style="color: #333333">=</span> <span style="color: #6600EE; font-weight: bold">1.0</span>;
  data <span style="color: #333333">=</span> mymulfunc(data);
  printf(<span style="background-color: #fff0f0">&quot;fmul output : </span><span style="background-color: #eeeeee">%.10f</span><span style="color: #666666; font-weight: bold; background-color: #fff0f0">\n</span><span style="background-color: #fff0f0">&quot;</span>, data);
  data <span style="color: #333333">=</span> myaddfunc(data);
  printf(<span style="background-color: #fff0f0">&quot;fadd output : </span><span style="background-color: #eeeeee">%.10f</span><span style="color: #666666; font-weight: bold; background-color: #fff0f0">\n</span><span style="background-color: #fff0f0">&quot;</span>, data);
  <span style="color: #008800; font-weight: bold">return</span> <span style="color: #0000DD; font-weight: bold">0</span>;
}
</pre></td></tr></table></div>
<!-- Compile the code -->    
$ <mark>gcc foo.c -o foo </mark>
$ <mark>./foo </mark>
fmul output : 2.5937424601
fadd output : 13.5937424601
</pre></td></tr>
</tbody></table></td></tr>
<tr><td colspan="3" bgcolor="black"><table border="0" cellpadding="0" cellspacing="2"><tbody><tr><td>
</td></tr>
</tbody></table></td></tr>
</tbody></table></td></tr>
</tbody></table></li>
<br>
<br>


<li class="li-enumerate">
<em>Generate the function symbol table (FST) of target application</em>
<p>In the guest Linux session, create a process.py program as follows: </p>
<div style="background: #ffffff; overflow:auto;width:auto;border:solid gray;border-width:.1em .1em .1em .8em;padding:.2em .6em;"><table><tr><td><pre style="margin: 0; line-height: 125%"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36</pre></td><td><pre style="margin: 0; line-height: 125%"><span style="color: #888888">#! /usr/bin/env</span>
<span style="color: #008800; font-weight: bold">import</span> <span style="color: #0e84b5; font-weight: bold">re</span>
<span style="color: #008800; font-weight: bold">import</span> <span style="color: #0e84b5; font-weight: bold">os.path</span>
<span style="color: #008800; font-weight: bold">import</span> <span style="color: #0e84b5; font-weight: bold">sys</span>

<span style="color: #DD4422">&#39;&#39;&#39;</span>
<span style="color: #DD4422">  This python script will clean the symbol table </span>
<span style="color: #DD4422">  - Qiang Guan, LANL</span>
<span style="color: #DD4422">&#39;&#39;&#39;</span>
<span style="color: #888888"># Start</span>
<span style="color: #008800; font-weight: bold">if</span> <span style="color: #007020">len</span>(sys<span style="color: #333333">.</span>argv)<span style="color: #333333">&lt;</span><span style="color: #0000DD; font-weight: bold">3</span>:
	<span style="color: #008800; font-weight: bold">print</span> <span style="background-color: #fff0f0">&quot;Usage: ./process.py binary_file symbol_table&quot;</span>
	sys<span style="color: #333333">.</span>exit() 

in_file <span style="color: #333333">=</span> sys<span style="color: #333333">.</span>argv[<span style="color: #0000DD; font-weight: bold">1</span>] <span style="color: #888888"># Input file is a binary</span>
out_file <span style="color: #333333">=</span> sys<span style="color: #333333">.</span>argv[<span style="color: #0000DD; font-weight: bold">2</span>] <span style="color: #888888"># Output file will be a symbol table</span>
tmp_file <span style="color: #333333">=</span> <span style="background-color: #fff0f0">&quot;all_symbols&quot;</span>
cmd_str <span style="color: #333333">=</span> <span style="background-color: #fff0f0">&quot;readelf --syms ./&quot;</span><span style="color: #333333">+</span>in_file<span style="color: #333333">+</span><span style="background-color: #fff0f0">&quot; &gt;&gt; &quot;</span><span style="color: #333333">+</span>tmp_file

<span style="color: #008800; font-weight: bold">if</span> os<span style="color: #333333">.</span>system(cmd_str)<span style="color: #333333">!=</span><span style="color: #0000DD; font-weight: bold">0</span>:
	<span style="color: #008800; font-weight: bold">print</span> <span style="background-color: #fff0f0">&quot;Failed in generating symbol table!&quot;</span>
	sys<span style="color: #333333">.</span>exit()

<span style="color: #008800; font-weight: bold">if</span> os<span style="color: #333333">.</span>path<span style="color: #333333">.</span>isfile(tmp_file)<span style="color: #333333">!=</span><span style="color: #007020">True</span>:
	<span style="color: #008800; font-weight: bold">print</span> <span style="background-color: #fff0f0">&quot;Symbol table file </span><span style="background-color: #eeeeee">%s</span><span style="background-color: #fff0f0"> not exist!&quot;</span> <span style="color: #333333">%</span>in_file
	sys<span style="color: #333333">.</span>exit()


inputfile <span style="color: #333333">=</span> <span style="color: #007020">open</span>(tmp_file, <span style="background-color: #fff0f0">&quot;r&quot;</span>);
outputfile <span style="color: #333333">=</span> <span style="color: #007020">open</span>(out_file, <span style="background-color: #fff0f0">&quot;w&quot;</span>)
<span style="color: #008800; font-weight: bold">for</span> line <span style="color: #000000; font-weight: bold">in</span> inputfile:
	<span style="color: #008800; font-weight: bold">if</span> re<span style="color: #333333">.</span>match(<span style="background-color: #fff0f0">&quot;(.*)FUNC(.*)&quot;</span>, line): <span style="color: #888888"># Keep only FUNC</span>
		<span style="color: #008800; font-weight: bold">if</span> re<span style="color: #333333">.</span>match(<span style="background-color: #fff0f0">&quot;(.*) 0 FUNC(.*)&quot;</span>, line)<span style="color: #333333">==</span><span style="color: #007020">None</span>: <span style="color: #888888"># Clean empty FUNC</span>
			outputfile<span style="color: #333333">.</span>write(line)
inputfile<span style="color: #333333">.</span>close()
outputfile<span style="color: #333333">.</span>close()
</pre></td></tr></table>
</div>







<br><br>
<b>[Guest]:</b> <br>
<!-- Execute the script -->    
$ <mark>python process.py foo symbol_table_foo </mark>
<br><br>
Generated symbol_table_foo:
<!-- HTML generated using hilite.me -->
<div style="background: #000000; overflow:auto;width:auto;border:solid gray;border-width:.1em .1em .1em .8em;padding:.2em .6em;"><table><tr><td><pre style="margin: 0; line-height: 125%">1
2
3
4
5</pre></td><td><pre style="margin: 0; line-height: 125%">
    <span style="color: #cd00cd">57</span><span style="color: #3399cc">:</span> <span style="color: #cd00cd">080484b0</span>     <span style="color: #cd00cd">5</span> <span style="color: #cccccc">FUNC</span>    <span style="color: #cccccc">GLOBAL</span> <span style="color: #cccccc">DEFAULT</span>   <span style="color: #cd00cd">13</span> <span style="color: #cccccc">__libc_csu_fini</span>
    <span style="color: #cd00cd">66</span><span style="color: #3399cc">:</span> <span style="color: #cd00cd">080483c4</span>    <span style="color: #cd00cd">62</span> <span style="color: #cccccc">FUNC</span>    <span style="color: #cccccc">GLOBAL</span> <span style="color: #cccccc">DEFAULT</span>   <span style="color: #cd00cd">13</span> <span style="color: #cccccc">mymulfunc</span>
    <span style="color: #cd00cd">69</span><span style="color: #3399cc">:</span> <span style="color: #cd00cd">080484c0</span>    <span style="color: #cd00cd">90</span> <span style="color: #cccccc">FUNC</span>    <span style="color: #cccccc">GLOBAL</span> <span style="color: #cccccc">DEFAULT</span>   <span style="color: #cd00cd">13</span> <span style="color: #cccccc">__libc_csu_init</span>
    <span style="color: #cd00cd">72</span><span style="color: #3399cc">:</span> <span style="color: #cd00cd">08048402</span>    <span style="color: #cd00cd">62</span> <span style="color: #cccccc">FUNC</span>    <span style="color: #cccccc">GLOBAL</span> <span style="color: #cccccc">DEFAULT</span>   <span style="color: #cd00cd">13</span> <span style="color: #cccccc">myaddfunc</span>
    <span style="color: #cd00cd">76</span><span style="color: #3399cc">:</span> <span style="color: #cd00cd">08048440</span>   <span style="color: #cd00cd">102</span> <span style="color: #cccccc">FUNC</span>    <span style="color: #cccccc">GLOBAL</span> <span style="color: #cccccc">DEFAULT</span>   <span style="color: #cd00cd">13</span> <span style="color: #cccccc">main</span>
</pre></td></tr></table></div>

<p>The offset of memory address for the functions and the size in memory for storing the codes are listed
in the second column and third colunm. The last column lists the function name.</p>

<!-- Copy FST -->
<li class="li-enumerate">
<em><p><b>[Guest]</b> Copy the FST from guest to host.</em></p>
<p>For copying file from guest to host file system under the direcotory of
<code>source-code/tracecap/</code>, you have to access the
guest session and use scp to copy file(s) from guest to host.</p>
<b>[Guest]:</b> <br>
 $ <mark><code>scp symbol_table_foo your-id@host-ip:/....../SEFI-source-code/tracecap/</code></mark>
 
 
<!-- Configure FSEFI --> 
<br><br>    
<li class="li-enumerate">
<em>Configure FSEFI</em>
<p>Open the FSEFI configuration file <code>SEFI-source-code/tracecap/ini/SEFI_conf.ini</code></p>
<b>[Host]:</b> <br>
 $ <mark><code>vim SEFI-source-code/tracecap/ini/SEFI_conf.ini </code></mark><br>
<p>The directory of symbol_table should be specified under <code>SEFI_host_sym_table_directory</code></p>
<!-- HTML generated using hilite.me -->
<div style="background: #ffffff; overflow:auto;width:auto;border:solid gray;border-width:.1em .1em .1em .8em;padding:.2em .6em;"><table><tr><td><pre style="margin: 0; line-height: 125%">  1
  2
  3
  4
  5
  6
  7
  8
  9
 10
 11
 12
 13
 14
 15
 16
 17
 18
 19
 20
 21
 22
 23
 24
 25
 26
 27
 28
 29
 30
 31
 32
 33
 34
 35
 36
 37
 38
 39
 40
 41
 42
 43
 44
 45
 46
 47
 48
 49
 50
 51
 52
 53
 54
 55
 56
 57
 58
 59
 60
 61
 62
 63
 64
 65
 66
 67
 68
 69
 70
 71
 72
 73
 74
 75
 76
 77
 78
 79
 80
 81
 82
 83
 84
 85
 86
 87
 88
 89
 90
 91
 92
 93
 94
 95
 96
 97
 98
 99
100
101
102</pre></td><td><pre style="margin: 0; line-height: 125%"><span style="color: #888888">; Configuration file for SEFI</span>
<span style="color: #008800; font-weight: bold">[general]</span>

<span style="color: #888888">; set to &#39;yes&#39;, if &#39;fadd&#39; type is allowed to inject. </span>
<span style="color: #888888">; Default : yes</span>
<span style="color: #0000CC">SEFI_support_fault_fadd</span> <span style="color: #333333">=</span> <span style="background-color: #fff0f0">yes</span>

<span style="color: #888888">; set to &#39;yes&#39;, if &#39;fmul&#39; type is allowed to inject </span>
<span style="color: #888888">; Default : yes</span>
<span style="color: #0000CC">SEFI_support_fault_fmul</span> <span style="color: #333333">=</span> <span style="background-color: #fff0f0">yes</span>

<span style="color: #888888">; set to &#39;yes&#39;, if &#39;cmp&#39; type is allowed to inject </span>
<span style="color: #888888">; Default : yes</span>
<span style="color: #0000CC">SEFI_support_fault_cmp</span> <span style="color: #333333">=</span> <span style="background-color: #fff0f0">yes</span>

<span style="color: #888888">; set to &#39;yes&#39;, if &#39;xor&#39; type is allowed to inject </span>
<span style="color: #888888">; Default : yes</span>
<span style="color: #0000CC">SEFI_support_fault_xor</span> <span style="color: #333333">=</span> <span style="background-color: #fff0f0">yes</span>

<span style="color: #888888">; set to &#39;yes&#39;, if &#39;sarl&#39; type is allowed to inject </span>
<span style="color: #888888">; Default : yes</span>
<span style="color: #0000CC">SEFI_support_fault_sarl</span> <span style="color: #333333">=</span> <span style="background-color: #fff0f0">yes</span>

<span style="color: #888888">; set to &#39;yes&#39;, if &#39;idivl&#39; type is allowed to inject </span>
<span style="color: #888888">; Default : yes</span>
<span style="color: #0000CC">SEFI_support_fault_idivl</span> <span style="color: #333333">=</span> <span style="background-color: #fff0f0">yes</span>

<span style="color: #888888">; set to &#39;yes&#39;, if &#39;imul&#39; type is allowed to inject </span>
<span style="color: #888888">; Default : yes</span>
<span style="color: #0000CC">SEFI_support_fault_imul</span> <span style="color: #333333">=</span> <span style="background-color: #fff0f0">yes</span>

<span style="color: #888888">; set to &#39;yes&#39;, if dynamic probability model is enabled </span>
<span style="color: #888888">; Default : no</span>
<span style="color: #0000CC">SEFI_support_dynamic_probability</span> <span style="color: #333333">=</span> <span style="background-color: #fff0f0">no</span>

<span style="color: #888888">; The range of bits that are available to flip (based on 64 bits register)</span>
<span style="color: #888888">; Default : 52-62</span>
<span style="color: #888888">; Example : 52-62 (inject faults into the exponent area of a 64bits register)</span>
<span style="color: #0000CC">SEFI_support_range_start</span> <span style="color: #333333">=</span> <span style="background-color: #fff0f0">52</span>
<span style="color: #0000CC">SEFI_support_range_end</span> <span style="color: #333333">=</span> <span style="background-color: #fff0f0">62</span>

<span style="color: #888888">; integer that less sizeof bit_range</span>
<span style="color: #888888">; Default : 1</span>
<span style="color: #888888">; Example: if SEF_support_sub_bit_range is set 52-62, then it cannot set larger than 11 bits to inject faults.</span>
<span style="color: #888888">;          FSEFI will validate it. And if the number exceeds the sizeof range, number</span>
<span style="color: #888888">;          will be set as the sizeof range</span>
<span style="color: #0000CC">SEFI_support_number_of_bits_to_flip</span> <span style="color: #333333">=</span> <span style="background-color: #fff0f0">1 </span>

<span style="color: #888888">; [double] probability of faults</span>
<span style="color: #888888">; Example: - If SEFI_support_fault_probability is set 100, then fault is going to be inject with</span>
<span style="color: #888888">;          100 percentages.</span>
<span style="color: #888888">;          - 0 means the probability mode is disabled. The number of injections per run depends on the</span>
<span style="color: #888888">;          user defined option &quot;-n&quot;</span>
<span style="color: #888888">; Defautl : 0</span>
<span style="color: #0000CC">SEFI_support_fault_probability</span> <span style="color: #333333">=</span> <span style="background-color: #fff0f0">0</span>

<span style="color: #888888">; [integer] index of the start of fadd opes, where the injector will inject faults</span>
<span style="color: #888888">; Default : 0</span>
<span style="color: #888888">; Example : 0 (the inject will inject fault from the first Fadd)</span>
<span style="color: #0000CC">SEFI_support_start_index_fadd</span> <span style="color: #333333">=</span> <span style="background-color: #fff0f0">0</span>

<span style="color: #888888">; [integer] index of the start of fmul opes, where the injector will inject faults</span>
<span style="color: #888888">; Default : 0</span>
<span style="color: #888888">; Example : 0 (the inject will inject fault from the first fmul)</span>
<span style="color: #0000CC">SEFI_support_start_index_fmul</span> <span style="color: #333333">=</span> <span style="background-color: #fff0f0">0</span>

<span style="color: #888888">; [integer] index of the start of cmp opes, where the injector will inject faults</span>
<span style="color: #888888">; Default : 0</span>
<span style="color: #888888">; Example : 0 (the inject will inject fault from the first cmp)</span>
<span style="color: #0000CC">SEFI_support_start_index_cmp</span> <span style="color: #333333">=</span> <span style="background-color: #fff0f0">0</span>

<span style="color: #888888">; [integer] index of the start of xor opes, where the injector will inject faults</span>
<span style="color: #888888">; Default : 0</span>
<span style="color: #888888">; Example : 0 (the inject will inject fault from the first xor)</span>
<span style="color: #0000CC">SEFI_support_start_index_xor</span> <span style="color: #333333">=</span> <span style="background-color: #fff0f0">0</span>

<span style="color: #888888">; [integer] index of the start of sarl opes, where the injector will inject faults</span>
<span style="color: #888888">; Default : 0</span>
<span style="color: #888888">; Example : 0 (the inject will inject fault from the first sarl)</span>
<span style="color: #0000CC">SEFI_support_start_index_sarl</span> <span style="color: #333333">=</span> <span style="background-color: #fff0f0">0</span>

<span style="color: #888888">; [integer] index of the start of imul opes, where the injector will inject faults</span>
<span style="color: #888888">; Default : 0</span>
<span style="color: #888888">; Example : 0 (the inject will inject fault from the first imul)</span>
<span style="color: #0000CC">SEFI_support_start_index_imul</span> <span style="color: #333333">=</span> <span style="background-color: #fff0f0">0</span>

<span style="color: #888888">; [integer] max dynmic instructions</span>
<span style="color: #888888">; defualt : 1 (you can specify it when you have more information from profile)</span>
<span style="color: #888888">; Example : 100 (the injection will be randomly chosen from 1st target instruction to 100th</span>
<span style="color: #888888">;           if SEFI_support_start_index_fadd = 1 )</span>
<span style="color: #0000CC">SEFI_support_max_dic</span> <span style="color: #333333">=</span> <span style="background-color: #fff0f0">100</span>

<span style="color: #008800; font-weight: bold">[host configuration]</span>

<span style="color: #888888">; [string]directory of symbol_table for subroutine injection</span>
<span style="color: #888888">; Default: NULL</span>
<span style="color: #0000CC">SEFI_host_sym_table_directory</span> <span style="color: #333333">=</span> <span style="background-color: #fff0f0">tracecap/symbol_table_foo</span>
</pre></td></tr></table></div>




<!-- profile -->
<br><br>    
<li class="li-enumerate">
<em>Profile target application/function </em>
<p>- Load the tracecap.so. At the (FSEFI) prompt, say:</p>
<table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td colspan="3" bgcolor="black"><table border="0" cellpadding="0" cellspacing="2"><tbody><tr><td>
</td></tr>
</tbody></table></td></tr>
<tr><td><table border="0" cellpadding="10" cellspacing="0"><tbody><tr><td>
<pre class="verbatim">
SEFI(QEMU 0.9.1) monitor - type 'help' for more information
<b>(SEFI) </b> <mark>load_plugin tracecap/tracecap.so</mark>
general/trace_only_after_first_taint is enabled.
general/log_external_calls is disabled.
general/write_ops_at_insn_end is disabled.
general/save_state_at_trace_stop is disabled.
tracing/tracing_table_lookup is enabled.
tracing/tracing_tainted_only is disabled.
tracing/tracing_single_thread_only is disabled.
tracing/tracing_kernel is disabled.
tracing/tracing_kernel_tainted is disabled.
tracing/tracing_kernel_partial is disabled.
network/ignore_dns is disabled.
Enabled: 0x00 Proto: 0x00 Sport: 0 Dport: 0 Src: 0.0.0.0 Dst: 0.0.0.0
Loading plugin options from: /home/guanxyz/FSEFI_CURRENT/tracecap/ini/hook_plugin.ini
Loading plugins from: /home/guanxyz/FSEFI_CURRENT/shared/hooks/hook_plugins
general/SEFI_support_fault_fadd is enabled.
general/SEFI_support_fault_fmul is enabled.
general/SEFI_support_fault_cmp is enabled.
general/SEFI_support_fault_xor is enabled.
general/SEFI_support_fault_sarl is enabled.
general/SEFI_support_fault_idivl is enabled.
general/SEFI_support_fault_imul is enabled.
general/SEFI_support_dynamic_probability is disabled.
SEFI configuration is loaded successfully
SEFI configuration: faulty bits from <b>52 to 62 </b>( <b>1</b> bit(s)) with probability <b>0.000000</b>
------ THE EXTENDED PRECISION is ENABLED.
Cannot determine file system type
Cannot determine file system type
Cannot determine file system type
tracecap/tracecap.so is loaded successfully!
<b>(SEFI) </b> <mark>enable_emulation</mark>
Emulation is now enabled
</pre></td></tr>
</tbody></table></td></tr>
<tr><td colspan="3" bgcolor="black"><table border="0" cellpadding="0" cellspacing="2"><tbody><tr><td>
</td></tr>
</tbody></table></td></tr>
</tbody></table></td></tr>
</tbody></table><p>The warning about <code>Cannot determine file system type</code> applies to
functionality we won’t be using, and can be
ignored. <code>enable_emulation</code> is required to activate any of instraction tracing hooks; without it,
later steps won’t see any of the instructions executed.</p>     

<p>- Command FSEFI to profile target application & function </p>
<table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td colspan="3" bgcolor="black"><table border="0" cellpadding="0" cellspacing="2"><tbody><tr><td>
</td></tr>
</tbody></table></td></tr>
<tr><td><table border="0" cellpadding="10" cellspacing="0"><tbody><tr><td>
<pre class="verbatim">
<b>(SEFI) </b> <mark>profile2func foo mymulfunc</mark>
</pre></td></tr>
</tbody></table></td></tr>
<tr><td colspan="3" bgcolor="black"><table border="0" cellpadding="0" cellspacing="2"><tbody><tr><td>
</td></tr>
</tbody></table></td></tr>
</tbody></table></td></tr>
</tbody></table>

<p>- Execute the <code>foo</code> in guest session and you will see the printing from FSEFI prompt</p>
<b>[Guest]:</b><br>
<pre class="verbatim">
<mark>$./foo</mark>
fmul output : 2.593742
fadd output : 13.593742
</pre>
<b>[FSEFI]:</b><br>
<table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td colspan="3" bgcolor="black"><table border="0" cellpadding="0" cellspacing="2"><tbody><tr><td>
</td></tr>
</tbody></table></td></tr>
<tr><td><table border="0" cellpadding="10" cellspacing="0"><tbody><tr><td>
<pre class="verbatim">
Tracing process :foo PID:2958 func:mymulfunc
module: [foo] 0x08048000 -- 0x08049000 
Monitoring :0x80483C4 -- 0x80483FF
Target program 'foo' exits! -1 more runs
</pre></td></tr>
</tbody></table></td></tr>
<tr><td colspan="3" bgcolor="black"><table border="0" cellpadding="0" cellspacing="2"><tbody><tr><td>
</td></tr>
</tbody></table></td></tr>
</tbody></table></td></tr>
</tbody></table>
<p>FSEFI traced process foo with process id 2958 and monitored the memory space
<code>0x080483C4 -- 0x080483FF</code> as we defined in FST. Whenever Execution Instruction
Pointer EIP accessed
the memory address within this rang, FSEFI will extract the EIP and verify the
EIP pointer. If EIP pointed to a <code>fmul</code> operation, FSEFI profiler will add
the occurance counter of <code>fmul</code> by one</p>

<p>- Stop profiling using FSEFI command <code>trace_stop</code>.</p>
<b>[FSEFI]:</b><br>
<table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td colspan="3" bgcolor="black"><table border="0" cellpadding="0" cellspacing="2"><tbody><tr><td>
</td></tr>
</tbody></table></td></tr>
<tr><td><table border="0" cellpadding="10" cellspacing="0"><tbody><tr><td>
<pre class="verbatim">
<b>(SEFI) </b> <mark>trace_stop</mark>
</pre></td></tr>
</tbody></table></td></tr>
<tr><td colspan="3" bgcolor="black"><table border="0" cellpadding="0" cellspacing="2"><tbody><tr><td>
</td></tr>
</tbody></table></td></tr>
</tbody></table></td></tr>
</tbody></table>

<p>- Extract profile result from <code>FSEFI_source/SEFI.log</code> in Host.</p>
<b>[Host]:</b><br>
<!-- HTML generated using hilite.me -->
<!-- HTML generated using hilite.me --><div style="background: #ffffff; overflow:auto;width:auto;border:solid gray;border-width:.1em .1em .1em .8em;padding:.2em .6em;"><pre style="margin: 0; line-height: 125%">[<span style="color: #6600EE; font-weight: bold">23</span>, <span style="color: #6600EE; font-weight: bold">Feb</span>,<span style="color: #6600EE; font-weight: bold">23</span>:<span style="color: #6600EE; font-weight: bold">42</span>:<span style="color: #6600EE; font-weight: bold">47</span>] [PROFILE] fadd: <span style="color: #6600EE; font-weight: bold">10</span>, fmul: <span style="color: #6600EE; font-weight: bold">0</span>, xor:<span style="color: #6600EE; font-weight: bold">0</span>, <span style="color: #007020">cmp</span>:<span style="color: #6600EE; font-weight: bold">11</span> sarl:<span style="color: #6600EE; font-weight: bold">0</span> idivl:<span style="color: #6600EE; font-weight: bold">0</span> imul:<span style="color: #6600EE; font-weight: bold">0</span>
</pre></div>
<p>There are 10 <code>fadd</code> operations and 11 <code>cmp</code> operations used in target application
and target function <code>myaddfunc()</code>. When configuring the injector, if the start index is set as 0, max of dynamic instructions for
injection can be configured as 10 if we target to fadd operation or 11 if we target to cmp operation. The addition
of the start index and max number of dynamic instruction count should not exceed the profile result, in this example, which is 10 or 11.</p>

<!-- Inject -->
<li class="li-enumerate">
<em>Inject faults into application/function at runtime </em>
<p>- Setup the injector by commanding in FSEFI prompt:</p>
<b>[FSEFI]:</b><br>
<table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td colspan="3" bgcolor="black"><table border="0" cellpadding="0" cellspacing="2"><tbody><tr><td>
</td></tr>
</tbody></table></td></tr>
<tr><td><table border="0" cellpadding="10" cellspacing="0"><tbody><tr><td>
<pre class="verbatim">
<b>(SEFI) </b> <mark>batch_run -a foo -t fadd -f myaddfunc -m 10 -n 1 -r 1</mark>
SEFI: Waiting for process foo to inject <b>1</b> '<b>add</b>' fault(s) in function <b>myaddfunc</b>.
Process <b>foo</b> is registered.
</pre></td></tr>
</tbody></table></td></tr>
<tr><td colspan="3" bgcolor="black"><table border="0" cellpadding="0" cellspacing="2"><tbody><tr><td>
</td></tr>
</tbody></table></td></tr>
</tbody></table></td></tr>
</tbody></table>     
The manual of <code>batch_run</code>:</p>

<p><a name="index-ELF-file-information-147"></a><a name="index-readelf-148"></a>
<!-- man title readelf Displays information about ELF files. -->

<pre class="smallexample">     <!-- man begin SYNOPSIS readelf -->
   batch_run [<samp><span class="option">-a</span></samp> &lt;target application&gt;]
             [<samp><span class="option">-t</span></samp> &lt;operation type&gt;]
             [<samp><span class="option">-f</span></samp> &lt;target function&gt;]
             [<samp><span class="option">-m</span></samp> &lt;max number of dynamic instruction count&gt;]
             [<samp><span class="option">-n</span></samp> &lt;number of injections in each run&gt;]
             [<samp><span class="option">-r</span></samp> &lt;number of runs of application&gt;]
     <!-- man end -->
</pre>
<dl>
    <dt><samp><span class="env">-a</span></samp><dd>Define the target application.
    <br><dt><samp><span class="env">-t</span></samp><dd>Define the type of operations for injections. Currently
    we suppport <code>fadd, fmul, xor, cmp, sarl, idivl, imul</code>. But we are able to add more for
    customization.
    <br><dt><samp><span class="env">-f</span></samp><dd>Define the target function. It is optional. If you
    are injecting faults into application level only, you don't have to set this.
    <br><dt><samp><span class="env">-m</span></samp><dd>Define the max number of dynamic instruction count. If
    it is not set, SEFI will load the default value from <code>SEFI_conf.ini</code>. If the probablity is not set
    as 0, this option will be automaically disabled.
    <br><dt><samp><span class="env">-n</span></samp><dd>Define the number of injections in each run of application.
    You are able to inject multiple faults by setting proper value here. If the probablity is not set
    as 0, this option will be automaically disabled.
    <br><dt><samp><span class="env">-r</span></samp><dd>Define the number of runs of applications. This feature
    enables the batch mode fault injection campagin. You can write a script to repeat the application in
    guest and set this option with the exact same number of runs of applications. Let FSEFI to
    inject fault(s) in each run of the application.
</dl>    

<p>- Execute the <code>foo</code> in guest session.</p>
<b>[Guest]:</b><br>
<pre class="verbatim">
<mark>$./foo</mark>
fmul output : 2.593742
fadd output : <b>2754157841571327825859331172157156753408.000000</b>
</pre>
<b>[FSEFI]:</b><br>
<table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td colspan="3" bgcolor="black"><table border="0" cellpadding="0" cellspacing="2"><tbody><tr><td>
</td></tr>
</tbody></table></td></tr>
<tr><td><table border="0" cellpadding="10" cellspacing="0"><tbody><tr><td>
<pre class="verbatim">
<b>(SEFI) </b> Process foo starts...
Tracing process :foo PID:3623 func:myaddfunc
module: [foo] 0x08048000 -- 0x08049000 
Monitoring :0x8048402 -- 0x8048440
unmasked Register:40202fff0300c08f, ST0:8
Eip: 0x0804842C, BitFlipMask: 800000000000000, AfterInjection:2754157841571327825859331172157156753408.000000, BeforeInjection:8.093742 DIC:5
Target program 'foo' exits!  
</pre></td></tr>
</tbody></table></td></tr>
<tr><td colspan="3" bgcolor="black"><table border="0" cellpadding="0" cellspacing="2"><tbody><tr><td>
</td></tr>
</tbody></table></td></tr>
</tbody></table></td></tr>
</tbody></table>
<p>Information about the injection is shown in FSEFI prompt as well as in the <code>SEFI.log</code> log file for post-process</p>
<!-- HTML generated using hilite.me -->
<div style="background: #ffffff; overflow:auto;width:auto;border:solid gray;border-width:.1em .1em .1em .8em;padding:.2em .6em;"><pre style="margin: 0; line-height: 125%">[24,Feb,00:19:30] [INFO] SEFI: Waiting for process foo to inject 1 &#39;add&#39; fault(s) in function myaddfunc
[24,Feb,00:55:22] [INFO] Tracing process :foo PID:3623 func:myaddfunc 
[24,Feb,00:55:22] [myaddfunc] FaultyOp:ADD_OP,eip:0x0804842C, Original:8.093742, BitflipMask:800000000000000, AfterInjection:2754157841571327825859331172157156753408.000000 DynamicInstruction:5
</pre></div>
<p>The first entry indicates that FSEFI is ready for injection. The second entry indicate the time of finding
the application running by SEFI probe. The third entry shows the details about the injection, including type of
instruction for injection, EIP while injecting fault, original value before injection, which bit is flipped, value after injection
and the dynamic instruction count.</p>

 
     
     
<!--TOC section Troubleshooting-->
<h2 class="section"><!--SEC ANCHOR --><a name="htoc6">6</a>&nbsp;&nbsp;Batch Mode</h2><!--SEC END -->
<p>FSEFI allows batch processing for injecting faults into multiple runs of application. This feature especially
supports the statistic study of application's vulnerabality. Using option <tt>-r</tt> in FSEFI command <tt>batch_run</tt>
to specify the required number of runs of application. All the other configurations provide the same functionalities
as the single mode. But with different random seeds, the injection in each trial will be different. For example, bit-flip
position, dynamic instruction index, et al. Besides, the user should guarentee that the input data for each trial are same.</p>

<p>The user should also write batch script in Guest VM to repeat the execution of target application and collect the
execution results from each run of the application so that the post-process can map the fault injection information
to the execution result. You can refer to this script <tt>runfoo.sh</tt>:</p>

<!-- HTML generated using hilite.me --><div style="background: #ffffff; overflow:auto;width:auto;border:solid gray;border-width:.1em .1em .1em .8em;padding:.2em .6em;"><pre style="margin: 0; line-height: 125%">  <span style="color: #888888">#! /bin/bash</span>
  <span style="color: #996633">OUTPUTFILE</span><span style="color: #333333">=</span>result
  <span style="color: #996633">COUNT</span><span style="color: #333333">=</span>20
  rm result
  <span style="color: #008800; font-weight: bold">until</span> <span style="color: #333333">[</span> <span style="color: #996633">$COUNT</span> -lt 0 <span style="color: #333333">]</span>;
  <span style="color: #008800; font-weight: bold">do</span>
     ./foo &gt;&gt; result
     <span style="color: #007020">let </span>COUNT-<span style="color: #333333">=</span>1
  <span style="color: #008800; font-weight: bold">done</span>
</pre></div>
<br>
<p>The <tt>batch_run</tt> command should also be specified with same numbers of trials. When the last trail finished it will show "0 more runs".</p>
<table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td colspan="3" bgcolor="black"><table border="0" cellpadding="0" cellspacing="2"><tbody><tr><td>
</td></tr>
</tbody></table></td></tr>
<tr><td><table border="0" cellpadding="10" cellspacing="0"><tbody><tr><td>
<pre class="verbatim">
<b>(SEFI) </b> batch_run -a foo -t fadd -f myaddfunc -m 10 -n 1 -r <mark>20</mark>
SEFI: Waiting for process foo to inject <b>1</b> '<b>add</b>' fault(s) in function <b>myaddfunc</b>.
Process <b>foo</b> is registered.
...
...
Target program 'foo' exits! 0 more runs
</pre></td></tr>
</tbody></table></td></tr>
<tr><td colspan="3" bgcolor="black"><table border="0" cellpadding="0" cellspacing="2"><tbody><tr><td>
</td></tr>
</tbody></table></td></tr>
</tbody></table></td></tr>
</tbody></table>      
     

<!--TOC section Troubleshooting-->
<h2 class="section"><!--SEC ANCHOR --><a name="htoc7">7</a>&nbsp;&nbsp;Troubleshooting</h2><!--SEC END --><p>
This section describes some problems users have experienced when using FSEFI, 
along with the most common causes of these problems.</p>

<ol class="enumerate" type="1">
<li class="li-enumerate">
<em>SEFI does not begin probing program</em>
<ul class="itemize">
<li class="li-itemize"> Did you remember to <tt>load_plugin</tt> the tracecap.so hooks before running the program? </li>
<li class="li-itemize"> Did you remember to <tt>enable_emulation</tt> before running the program? </li>
<li class="li-itemize"> Did you remember to <tt>reboot_SEFI</tt> before re-running the program? For example, after
profiling, you may need to reboot SEFI for the injection.</li>
<li class="li-itemize">Did you enter correct application name and function name in  (<tt>batch_cmd</tt> command)? </li>
</ul>
</li>

<li class="li-enumerate"><em>Profiling result is not written into SEFI.log</em>
<ul class="itemize">
<li class="li-itemize">Did you remember to run <tt>trace_stop</tt>? </li>
<li class="li-itemize">Are you using the <em>tracecap</em> plugin? The <em>tracecap</em> can be configured 
to probe only certain types of instructions (for instance, fadd and fmul). Check the plugin settings in the SEFI_conf.ini file. </li>
</ul> 
</li>

<li class="li-enumerate"><em>I cannot find the results of my application.</em>
<ul class="itemize"><li class="li-itemize">
You have to access the guest linux session and then use <tt>scp</tt> to copy the results from
guest to host system. So we strongly suggest that you should write a script for executing
mutltipl runs of your applications and keep the results somewhere after each run. You can
find an example of a batch script of running <tt>foo</tt>.
</li></ul>
</li>

<li class="li-enumerate"><em>Compile warnings about </em><em><tt>fastcall</tt></em>
<ul class="itemize"><li class="li-itemize">
Are you trying to compile with GCC 3.3? It isn’t supported.
</li></ul>
</li>

<li class="li-enumerate"><em>XWindow displaying problem</em>
<ul class="itemize"><li class="li-itemize">
You need to install SDL library to enable the GUI for Guest session (You have to access Guest session to
control the injection). If you are accessing the host server remotely, your local machine has to be
installed with SDL library. For Mac user, you can install XQuartz (it can be downloaded via http://xquartz.macosforge.org/landing/).
Current version is 2.7.7 (tested version with FSEFI).
</li></ul>
</li>


<li class="li-enumerate"><em>Mac XQuartz window not working properly</tt></em>
<ul class="itemize"><li class="li-itemize">
When you use Mac XQuartz to remotely boot VM, if you reattach the external monitor after the laptop has been disconnected and gone in to sleep mode,
a new X Window would appear in the lower portion of the screen. Attempts to resize it or drag it into the upper portion fail. It is a bug still unfixed
for XQuartz 2.7.7 with OS X Mavericks. We haven't tested it in OS X Yosemite yet. 
</li></ul>
</li>

<li class="li-enumerate"><em>The profile result makes no sense</tt></em>
<ul class="itemize"><li class="li-itemize">
Sometimes when you find that your profile results makes no sense, It is probably because you didn't turn off the profiler for your last profile.
That may result in the profiler keep counting and produce non-sense number. Please always use trace_stop to turn off the profiler even though
that is not the result you want to know. Also if you run reboot_SEFI all the time before you start a new profile, that may keep you away from
this problem.
</li></ul>
</li>

<li class="li-enumerate"><em>FSEFI can’t find a BIOS image or keymap</em>
<ul class="itemize"><li class="li-itemize">
Either run <tt>make install</tt> to put these in the locations
FSEFI is expecting, or give their locations with the -L flag.
</li></ul>
</li>

<li class="li-enumerate"><em>How to switch between SEFI/Host and Guest.</em>
<ul class="itemize"><li class="li-itemize">
For Mac you can use the <tt>[Command]+[tab]</tt> to exit Guest and get back to the Host. For others,
you can use [Ctlr]+[Alt] to switch out of the Guest.
</li></ul>
</li>

<li class="li-enumerate"><em>More memory than 2024 MB for VM? NO!</em>
<ul class="itemize"><li class="li-itemize">
Our Guest now only support 32bits linux kernels. So Guest system running 32bits linux kernel
can assign a maximium of 2035 MB (acctually less than 2048MB).
</li></ul>
</li>


</ol><!--TOC section Acknowledgements-->
<h2 class="section"><!--SEC ANCHOR --><a name="htoc8">8</a>&nbsp;&nbsp;Acknowledgements</h2>
<!--SEC END -->
<p>FSEFI is built on TEMU (UC Berkely).</p><!--TOC section Reporting Bugs-->

<!--CUT END -->
<!--HTMLFOOT-->
<!--ENDHTML-->
<!--FOOTER-->
<hr size="2"><blockquote class="quote"><em>
</em><em></em></blockquote>

</body></html>
